# Database

## Supabase

This application uses Supabase which wraps a Postgresql database.

### Initial Setup

A database called `archeology` was set up.

A table for artifacts was created.

```sql
create table
  public.artifacts (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone not null default now(),
    updated_at timestamp with time zone null,
    name text not null default ''::text,
    description text not null default ''::text,
    dimensions text not null default ''::text,
    object_id text not null default ''::text,
    date text not null default ''::text,
    constraint artifacts_pkey primary key (id)
  ) tablespace pg_default;
```

A trigger was created for automatically updating the `updated_at` column on rows
in the `artifacts` table when the row is updated. The trigger used the
`moddatetime` extension.

```sql
create trigger handle_updated_at before
update on artifacts for each row
execute function moddatetime ('updated_at');
```

A related table was created for artifact images.

```sql
create table
  public.artifact_images (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone null default now(),
    updated_at timestamp with time zone null,
    caption text not null default ''::text,
    url text not null default ''::text,
    artifact_id bigint not null,
    constraint artifact_images_pkey primary key (id),
    constraint artifact_images_artifact_id_fkey foreign key (artifact_id) references artifacts (id) on delete cascade
  ) tablespace pg_default;
```

Another related table was created for keeping track of likes on artifacts.

```sql
create table
  public.likes (
    id bigint generated by default as identity not null,
    artifact_id bigint not null,
    created_at timestamp with time zone not null default now(),
    count bigint not null default '0'::bigint,
    updated_at timestamp with time zone null,
    constraint likes_pkey primary key (id),
    constraint likes_artifact_id_key unique (artifact_id),
    constraint likes_artifact_id_fkey foreign key (artifact_id) references artifacts (id) on delete cascade
  ) tablespace pg_default;
```

A trigger was created for automatically updating the `updated_at` column on rows
in the `likes` table when the row is updated. The trigger used the `moddatetime`
extension.

```sql
create trigger handle_updated_at before
update on likes for each row
execute function moddatetime ('updated_at');
```

A function was set up to like an artifact. If the artifact is not already in the
`likes` table it creates a new entry and sets the count to 1. Otherwise, it
updates the existing entry by incrementing the count by 1.

```sql
CREATE OR REPLACE FUNCTION like_artifact(artifact_id_to_check INT)
RETURNS VOID AS
$func$
BEGIN
  EXECUTE format('INSERT INTO likes (artifact_id, count)
  VALUES ($1, 1) ON CONFLICT (artifact_id) DO update
  SET count = likes.count + 1 WHERE likes.artifact_id = $1')
  USING artifact_id_to_check;
END
$func$ LANGUAGE plpgsql;
```

Note: this function can be invoked via the Supabase JavaScript client using
a remote procedure call (rpc).
